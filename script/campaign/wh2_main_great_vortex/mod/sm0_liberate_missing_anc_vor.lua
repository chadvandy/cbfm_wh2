local subtype_anc = {
    ["wh2_main_hef_tyrion"] = {
		{"mission", "wh2_main_anc_armour_dragon_armour_of_aenarion", "wh2_main_great_vortex_hef_tyrion_dragon_armour_of_aenarion_stage_1", 6, "wh2_main_great_vortex_hef_tyrion_dragon_armour_of_aenarion_stage_4_mpc", "war.camp.advice.quest.tyrion.dragon_armour_of_aenarion.001"},
		{"mission", "wh2_main_anc_weapon_sunfang", "wh2_main_great_vortex_hef_tyrion_sunfang_stage_1", 10, "wh2_main_great_vortex_hef_tyrion_sunfang_stage_4_mpc", "war.camp.advice.quest.tyrion.sunfang.001"},
        {"mission", "wh2_main_anc_enchanted_item_heart_of_avelorn", "wh2_main_vortex_narrative_hef_the_phoenix_gate", 14}
    },
    ["wh2_main_hef_teclis"] = {
		{"mission", "wh2_main_anc_arcane_item_war_crown_of_saphery", "wh2_main_great_vortex_hef_teclis_war_crown_of_saphery_stage_1", 6, "wh2_main_great_vortex_hef_teclis_war_crown_of_saphery_stage_3_mpc", "war.camp.advice.quest.teclis.war_crown_of_saphery.001"},
		{"mission", "wh2_main_anc_weapon_sword_of_teclis", "wh2_main_great_vortex_hef_teclis_sword_of_teclis_stage_1", 10, "wh2_main_great_vortex_hef_teclis_sword_of_teclis_stage_3_mpc", "war.camp.advice.quest.teclis.sword_of_teclis.001"},
        {"mission", "wh2_main_anc_arcane_item_scroll_of_hoeth", "wh2_main_vortex_narrative_hef_the_lies_of_the_druchii", 14},
        {"mission", "wh2_main_anc_arcane_item_moon_staff_of_lileath", "wh2_main_vortex_narrative_hef_the_vermin_of_hruddithi", 18}
    },
    ["wh2_dlc10_hef_alarielle"] = {
        {"mission", "wh2_dlc10_anc_talisman_shieldstone_of_isha", "wh2_dlc10_vortex_alarielle_shieldstone_of_isha_1", 2},
		{"mission", "wh2_dlc10_anc_enchanted_item_star_of_avelorn", "wh2_dlc10_great_vortex_hef_alarielle_star_of_avelorn_stage_1", 15, "wh2_dlc10_great_vortex_hef_alarielle_star_of_avelorn_stage_5_mpc"}
    },
    ["wh2_dlc10_hef_alith_anar"] = {
        {"mission", "wh2_dlc10_anc_enchanted_item_the_shadow_crown", "wh2_dlc10_great_vortex_hef_alith_anar_the_shadow_crown", 2},
		{"mission", "wh2_dlc10_anc_weapon_moonbow", "wh2_dlc10_great_vortex_hef_alith_anar_the_moonbow_stage_1", 5, "wh2_dlc10_great_vortex_hef_alith_anar_the_moonbow_stage_4_mpc"}
    },
    ["wh2_dlc15_hef_eltharion"] = {
		{"mission","wh2_dlc15_anc_talisman_talisman_of_hoeth","wh2_dlc15_vortex_hef_eltharion_talisman_of_hoeth_stage_1",5,"wh2_dlc15_vortex_hef_eltharion_talisman_of_hoeth_stage_3_mpc"},
		{"mission","wh2_dlc15_anc_armour_helm_of_yvresse","wh2_dlc15_vortex_hef_eltharion_helm_of_yvresse_stage_1",7},
		{"mission","wh2_dlc15_anc_weapon_fangsword_of_eltharion","wh2_dlc15_vortex_hef_eltharion_fangsword_of_eltharion_stage_1",10}
    },
    ["wh2_dlc15_hef_imrik"] = {
        {"mission","wh2_dlc15_anc_armour_armour_of_caledor","wh2_dlc15_vortex_hef_imrik_armour_of_caledor_stage_1",5,"wh2_dlc15_vortex_hef_imrik_armour_of_caledor_stage_3_mpc"},
	},
    ["wh2_main_def_malekith"] = {
		{"mission", "wh2_main_anc_arcane_item_circlet_of_iron", "wh2_main_great_vortex_def_malekith_circlet_of_iron_stage_1", 6, "wh2_main_great_vortex_def_malekith_circlet_of_iron_stage_3_mpc", "war.camp.advice.quest.malekith.circlet_of_iron.001"},
		{"mission", "wh2_main_anc_weapon_destroyer", "wh2_main_great_vortex_def_malekith_destroyer_stage_1", 10, "wh2_main_great_vortex_def_malekith_destroyer_stage_3_mpc", "war.camp.advice.quest.malekith.destroyer.001"},
		{"mission", "wh2_main_anc_armour_supreme_spellshield", "wh2_main_great_vortex_def_malekith_supreme_spellshield_stage_1", 14, "wh2_main_great_vortex_def_malekith_supreme_spellshield_stage_3_mpc", "war.camp.advice.quest.malekith.supreme_spellshield.001"},
        {"mission", "wh2_main_anc_armour_armour_of_midnight", "wh2_main_vortex_narrative_def_hoteks_levy", 18}
    },
    ["wh2_main_def_morathi"] = {
		{"mission", "wh2_main_anc_weapon_heartrender_and_the_darksword", "wh2_main_great_vortex_def_morathi_heartrender_and_the_darksword_stage_1", 6, "wh2_main_great_vortex_def_morathi_heartrender_and_the_darksword_stage_6_mpc", "war.camp.advice.quest.morathi.heartrender_and_the_darksword.001"},
        {"mission", "wh2_main_anc_arcane_item_wand_of_the_kharaidon", "wh2_dlc14_def_wand_of_kharaidon", 4},
        {"mission", "wh2_main_anc_talisman_amber_amulet", "wh2_dlc14_def_amber_amulet", 2}
    },
    ["wh2_dlc10_def_crone_hellebron"] = {
		{"mission", "wh2_dlc10_anc_weapon_deathsword_and_the_cursed_blade", "wh2_dlc10_great_vortex_def_hellebron_deathsword_and_the_cursed_blade_stage_1", 8, "wh2_dlc10_great_vortex_def_hellebron_deathsword_and_the_cursed_blade_stage_4_mpc"},
        {"mission", "wh2_dlc10_anc_talisman_amulet_of_dark_fire", "wh2_dlc10_great_vortex_def_hellebron_amulet_of_dark_fire_stage_1", 2}
    },
    ["wh2_dlc14_def_malus_darkblade"] = {
		{"mission", "wh2_dlc14_anc_weapon_warpsword_of_khaine", "wh2_dlc14_vortex_def_malus_warpsword_of_khaine_stage_1", 5, "wh2_dlc14_vortex_def_malus_warpsword_of_khaine_stage_4_mpc"}
    },
    ["wh2_main_lzd_lord_mazdamundi"] = {
		{"mission", "wh2_main_anc_magic_standard_sunburst_standard_of_hexoatl", "wh2_main_great_vortex_lzd_mazdamundi_sunburst_standard_of_hexoatl_stage_1", 6, "wh2_main_great_vortex_lzd_mazdamundi_sunburst_standard_of_hexoatl_stage_4_mpc", "war.camp.advice.quest.mazdamundi.sunburst_standard_of_hexoatl.001"},
		{"mission", "wh2_main_anc_weapon_cobra_mace_of_mazdamundi", "wh2_main_great_vortex_lzd_mazdamundi_cobra_mace_of_mazdamundi_stage_1", 10, "wh2_main_great_vortex_lzd_mazdamundi_cobra_mace_of_mazdamundi_stage_3_mpc", "war.camp.advice.quest.mazdamundi.cobra_mace_of_mazdamundi.001"}
    },
    ["wh2_main_lzd_kroq_gar"] = {
		{"mission", "wh2_main_anc_weapon_revered_spear_of_tlanxla", "wh2_main_great_vortex_liz_kroq_gar_revered_spear_of_tlanxla_stage_1", 6, "wh2_main_great_vortex_liz_kroq_gar_revered_spear_of_tlanxla_stage_3_mpc", "war.camp.advice.quest.kroqgar.revered_spear_of_tlanxla.001"},
		{"mission", "wh2_main_anc_enchanted_item_hand_of_gods", "wh2_main_great_vortex_liz_kroq_gar_hand_of_gods_stage_1", 10, "wh2_main_great_vortex_liz_kroq_gar_hand_of_gods_stage_3_mpc", "war.camp.advice.quest.kroqgar.hand_of_gods.001"}
    },
    ["wh2_dlc12_lzd_tehenhauin"] = {
        {"mission", "wh2_dlc12_anc_enchanted_item_plaque_of_sotek", "wh2_dlc12_great_vortex_lzd_tehenhauin_plaque_of_sotek_stage_1", 8, "wh2_dlc12_great_vortex_lzd_tehenhauin_plaque_of_sotek_mp"}
    },
    ["wh2_dlc12_lzd_tiktaqto"] = {
        {"mission", "wh2_dlc12_anc_enchanted_item_mask_of_heavens", "wh2_dlc12_great_vortex_lzd_tiktaqto_mask_of_heavens_stage_1", 8, "wh2_dlc12_great_vortex_lzd_tiktaqto_mask_of_heavens_mp"}
    },
    ["wh2_dlc13_lzd_nakai"] = {
		{"mission", "wh2_dlc13_anc_enchanted_item_golden_tributes", "wh2_dlc13_vortex_lzd_nakai_golden_tributes_stage_1", 8, "wh2_dlc13_vortex_lzd_nakai_golden_tributes_stage_3"},
		{"mission", "wh2_dlc13_talisman_the_ogham_shard", "wh2_dlc13_vortex_lzd_nakai_the_ogham_shard_stage_1", 8, "wh2_dlc13_vortex_lzd_nakai_the_ogham_shard_stage_2"}
    },
    ["wh2_dlc13_lzd_gor_rok"] = {
		{"mission", "wh2_dlc13_anc_armour_the_shield_of_aeons", "wh2_dlc13_vortex_gorrok_the_shield_of_aeons_stage_1", 8, "wh2_dlc13_vortex_gorrok_the_shield_of_aeons_stage_3"},
        {"mission", "wh2_dlc13_anc_weapon_mace_of_ulumak", "wh2_dlc14_lzd_the_mace_of_ulumak", 2}
    },
    ["wh2_main_skv_lord_skrolk"] = {
		{"mission", "wh2_main_anc_arcane_item_the_liber_bubonicus", "wh2_main_great_vortex_skv_skrolk_liber_bubonicus_stage_1", 6, "wh2_main_great_vortex_skv_skrolk_liber_bubonicus_stage_3_mpc", "war.camp.advice.quest.skrolk.liber_bubonicus.001"},
		{"mission", "wh2_main_anc_weapon_rod_of_corruption", "wh2_main_great_vortex_skv_skrolk_rod_of_corruption_stage_1", 10, "wh2_main_great_vortex_skv_skrolk_rod_of_corruption_stage_3_mpc", "war.camp.advice.quest.skrolk.rod_of_corruption.001"}
    },
    ["wh2_main_skv_queek_headtaker"] = {
		{"mission", "wh2_main_anc_armour_warp_shard_armour", "wh2_main_great_vortex_skv_queek_headtaker_warp_shard_armour_stage_1", 6, "wh2_main_great_vortex_skv_queek_headtaker_warp_shard_armour_stage_6_mpc", "war.camp.advice.quest.queek.warp_shard_armour.001"},
		{"mission", "wh2_main_anc_weapon_dwarf_gouger", "wh2_main_great_vortex_skv_queek_headtaker_dwarfgouger_stage_1", 10, "wh2_main_great_vortex_skv_queek_headtaker_dwarfgouger_stage_4_mpc", "war.camp.advice.quest.queek.dwarfgouger.001"}
    },
    ["wh2_dlc09_skv_tretch_craventail"] = {
		{"mission", "wh2_dlc09_anc_enchanted_item_lucky_skullhelm", "wh2_dlc09_great_vortex_skv_tretch_lucky_skullhelm_stage_1", 8, "wh2_dlc09_great_vortex_skv_tretch_lucky_skullhelm_stage_5_mpc", "dlc09.camp.advice.quest.tretch.lucky_skullhelm.001"}
    },
    ["wh2_dlc12_skv_ikit_claw"] = {
        {"mission", "wh2_dlc12_anc_weapon_storm_daemon", "wh2_dlc12_great_vortex_ikit_claw_storm_daemon_stage_1", 8, "wh2_dlc12_great_vortex_ikit_claw_storm_daemon_mp"}
    },
    ["wh2_dlc14_skv_deathmaster_snikch"] = {
		{"mission", "wh2_dlc14_anc_armour_the_cloak_of_shadows", "wh2_dlc14_vortex_skv_snikch_the_cloak_of_shadows_stage_1", 5, "wh2_dlc14_vortex_skv_snikch_the_cloak_of_shadows_stage_4_mpc"},
        {"mission", "wh2_dlc14_anc_weapon_whirl_of_weeping_blades", "wh2_dlc14_vortex_skv_snikch_whirl_of_weeping_blades_stage_1", 3}
    },
    ["throt_quests"] = {
		{"mission", "wh2_dlc16_anc_enchanted_item_whip_of_domination", "wh2_dlc16_skv_throt_vortex_whip_of_domination_stage_1", 5, "wh2_dlc16_skv_throt_vortex_whip_of_domination_stage_4_mpc"},
		{"mission", "wh2_dlc16_anc_weapon_creature_killer", "wh2_dlc16_skv_throt_vortex_creature_killer_stage_1", 3}
	},
    ["wh2_dlc09_tmb_settra"] = {
		{"mission", "wh2_dlc09_anc_enchanted_item_the_crown_of_nehekhara", "wh2_dlc09_great_vortex_tmb_settra_the_crown_of_nehekhara_stage_1", 6, "wh2_dlc09_great_vortex_tmb_settra_the_crown_of_nehekhara_stage_5_mpc", "dlc09.camp.advice.quest.settra.the_crown_of_nehekhara.001"},
		{"mission", "wh2_dlc09_anc_weapon_the_blessed_blade_of_ptra", "wh2_dlc09_great_vortex_tmb_settra_the_blessed_blade_of_ptra_stage_1", 13, "wh2_dlc09_great_vortex_tmb_settra_the_blessed_blade_of_ptra_stage_3_mpc", "dlc09.camp.advice.quest.settra.the_blessed_blade_of_ptra.001"}
    },
    ["wh2_dlc09_tmb_arkhan"] = {
		{"mission", "wh2_dlc09_anc_weapon_the_tomb_blade_of_arkhan", "wh2_dlc09_great_vortex_tmb_arkhan_the_tomb_blade_of_arkhan_stage_1", 6, "wh2_dlc09_great_vortex_tmb_arkhan_the_tomb_blade_of_arkhan_stage_4_mpc", "dlc09.camp.advice.quest.arkhan.the_tomb_blade_of_arkhan.001"}
    },
    ["wh2_dlc09_tmb_khatep"] = {
		{"mission", "wh2_dlc09_anc_arcane_item_the_liche_staff", "wh2_dlc09_vortex_tmb_khatep_the_liche_staff_1", 6, "wh2_dlc09_great_vortex_tmb_khatep_the_liche_staff_stage_5_mpc", "dlc09.camp.advice.quest.khatep.the_liche_staff.001"}
    },
    ["wh2_dlc09_tmb_khalida"] = {
		{"mission", "wh2_dlc09_anc_weapon_the_venom_staff", "wh2_dlc09_great_vortex_tmb_khalida_venom_staff_stage_1", 12, "wh2_dlc09_great_vortex_tmb_khalida_venom_staff_stage_3_mpc", "dlc09.camp.advice.quest.khalida.venom_staff.001"}
    },
    ["wh2_dlc11_cst_harkon"] = {
        {"mission", "wh2_dlc11_anc_enchanted_item_slann_gold", "wh2_dlc11_cst_vortex_harkon_quest_for_slann_gold_stage_1", 15, "wh2_dlc11_great_vortex_qb_cst_luthor_harkon_slann_gold_MP", "wh2_dlc11.camp.advice.quest.harkon.001"}
    },
    ["wh2_dlc11_cst_noctilus"] = {
        {"mission", "wh2_dlc11_anc_enchanted_item_captain_roths_moondial", "wh2_dlc11_cst_vortex_noctilus_captain_roths_moondial_stage_1", 15, "wh2_dlc11_great_vortex_qb_cst_noctilus_captain_roths_moondial_MP", "wh2_dlc11.camp.advice.quest.noctilus.001"}
    },
    ["wh2_dlc11_cst_aranessa"] = {
        {"mission", "wh2_dlc11_anc_weapon_krakens_bane", "wh2_dlc11_great_vortex_cst_aranessa_krakens_bane_stage_1", 15, "wh2_dlc11_great_vortex_qb_cst_aranessa_saltspite_krakens_bane_MP", "wh2_dlc11.camp.advice.quest.aranessa.001"}
    },
    ["wh2_dlc11_cst_cylostra"] = {
        {"mission", "wh2_dlc11_anc_arcane_item_the_bordeleaux_flabellum", "wh2_dlc11_great_vortex_cst_cylostra_the_bordeleaux_flabellum_stage_1", 9, "wh2_dlc11_great_vortex_cylostra_the_bordeleaux_flabellum_mp", "wh2_dlc11.camp.advice.quest.cylostra.001"}
    },
    ["wh2_dlc11_def_lokhir"] = {
        {"mission", "wh2_main_anc_armour_helm_of_the_kraken", "wh2_dlc11_great_vortex_lokhir_helm_of_the_kraken_stage_1", 11, "wh2_dlc11_great_vortex_lokhir_fellheart_helm_of_the_kraken_mp", "wh2_dlc11.camp.advice.quest.lokhir.001"},
        {"mission", "wh2_dlc11_anc_weapon_red_blades", "wh2_dlc11_great_vortex_def_lokhir_red_blades_stage_1", 2}
    },
    ["wh2_dlc13_emp_cha_markus_wulfhart_0"] = {
		{"mission", "wh2_dlc13_anc_weapon_amber_bow", "wh2_dlc13_emp_wulfhart_vor_amber_bow_stage_1", 8,"wh2_dlc13_vortex_emp_wulfhart_amber_bow_stage_4"}
    },
    ["wh2_dlc14_brt_repanse"] = {
		{"mission", "wh2_dlc14_anc_weapon_sword_of_lyonesse", "wh2_dlc14_vortex_brt_repanse_sword_of_lyonesse_stage_1", 5, "wh2_dlc14_vortex_brt_repanse_sword_of_lyonesse_stage_4_mpc"}
    },
    ["wh2_dlc15_grn_grom_the_paunch"] = {
		{"mission", "wh2_dlc15_anc_weapon_axe_of_grom", "wh2_dlc15_vortex_grn_grom_axe_of_grom_stage_1", 5,"wh2_dlc15_vortex_grn_grom_axe_of_grom_stage_4_mpc"},
		{"mission", "wh2_dlc15_anc_enchanted_item_lucky_banner", "wh2_dlc15_main_grn_grom_lucky_banner_stage_1", 2}
    },
    ["sisters_of_twilight_quests"] = {
		{"mission", "wh2_dlc16_anc_mount_wef_cha_sisters_of_twilight_forest_dragon", "wh2_dlc16_great_vortex_wef_sisters_dragon_stage_1", 12,"wh2_dlc16_great_vortex_wef_sisters_dragon_stage_4_mpc"}
	}
} --: map<string, vector<vector<WHATEVER>>>

local missing_anc = {
    {["faction"] = "wh2_main_hef_avelorn", ["subtype"] = "wh2_dlc10_hef_alarielle", ["key"] = "wh2_dlc10_anc_magic_standard_banner_of_avelorn"},
    {["faction"] = "wh2_main_hef_avelorn", ["subtype"] = "wh2_dlc10_hef_alarielle", ["key"] = "wh2_dlc10_anc_arcane_item_stave_of_avelorn"},
    {["faction"] = "wh2_main_skv_clan_skyre", ["subtype"] = "wh2_dlc12_skv_ikit_claw", ["key"] = "wh2_dlc12_anc_armour_iron_frame"},
    {["faction"] = "wh_main_grn_crooked_moon", ["subtype"] = "dlc06_grn_skarsnik", ["key"] = "wh_dlc06_anc_magic_standard_skarsniks_boyz"},
    {["faction"] = "wh2_dlc12_lzd_cult_of_sotek", ["subtype"] = "wh2_dlc12_lzd_tehenhauin", ["key"] = "wh2_dlc12_anc_weapon_blade_of_the_serpents_tongue"},
    {["faction"] = "wh_main_grn_greenskins", ["subtype"] = "grn_grimgor_ironhide", ["key"] = "wh_main_anc_magic_standard_da_immortulz"},
    {["faction"] = "wh2_main_hef_eataine", ["subtype"] = "wh2_main_hef_prince_alastar", ["key"] = "wh2_main_anc_armour_lions_pelt"},
    {["faction"] = "wh_main_emp_middenland", ["subtype"] = "dlc03_emp_boris_todbringer", ["key"] = "wh_main_anc_talisman_the_white_cloak_of_ulric"},
    {["faction"] = "wh2_main_hef_nagarythe", ["subtype"] = "wh2_dlc10_hef_alith_anar", ["key"] = "wh2_dlc10_anc_talisman_stone_of_midnight"},
    {["faction"] = "wh2_dlc11_vmp_the_barrow_legion", ["subtype"] = "vmp_heinrich_kemmler", ["key"] = "wh2_dlc11_anc_follower_vmp_the_ravenous_dead"},
    {["faction"] = "wh2_main_lzd_tlaqua", ["subtype"] = "wh2_dlc12_lzd_tiktaqto", ["key"] = "wh2_dlc12_anc_weapon_the_blade_of_ancient_skies"},
    {["faction"] = "wh2_dlc11_cst_vampire_coast", ["subtype"] = "wh2_dlc11_cst_harkon", ["key"] = "wh2_dlc11_anc_follower_captain_drekla"},
    {["faction"] = "wh2_dlc15_hef_imrik", ["subtype"] = "wh2_dlc15_hef_imrik", ["key"] = "wh2_dlc15_anc_weapon_star_lance"}
} --:vector<map<string, string>>

function sm0_liberate_missing_anc_vor()
    -- Let's say AI Morathi ranks up to level 6 and gets her item. Her faction gets wiped out later on, but she comes back via liberation/rebel/script. 
    -- The AI recruits her again but decides to not equip the item. Later the player confederates her faction but morathi's item is still part of her (now "dead") faction.
    core:add_listener(
        "sm0_backup_CharacterTurnStart",
        "CharacterTurnStart",
        function(context)
            return subtype_anc[context:character():character_subtype_key()] ~= nil
        end,
        function(context)
            local character = context:character()--:CA_CHAR
            local quests = subtype_anc[character:character_subtype_key()]
            for i = 1, #quests do
                local current_quest_record = quests[i]
                local current_ancillary_key = current_quest_record[2]
                local current_mission_key = current_quest_record[3]
                local current_rank_req = current_quest_record[4]
                local mission_title = effect.get_localised_string("missions_localised_title_"..current_mission_key)
                if character:rank() >= current_rank_req and not character:faction():ancillary_exists(current_ancillary_key) then
                    local char_cqi = context:character():command_queue_index()
                    core:add_listener(
                        "sm0_backup_"..current_ancillary_key.."_CharacterTurnEnd",
                        "CharacterTurnEnd",
                        function(context)
                            return context:character():command_queue_index() == char_cqi
                        end,
                        function(context)
                            if character:faction():is_human() and current_mission_key ~= "" then 
                                if cm:is_local_players_turn() then
                                    local mission_found = false
                                    local mission_button = find_uicomponent(core:get_ui_root(),"layout", "bar_small_top", "TabGroup", "tab_missions")
                                    mission_button:SimulateLClick()
                                    local list_box = find_uicomponent(core:get_ui_root(),"layout", "radar_things", "dropdown_parent", "missions_dropdown", "panel", "panel_clip", "list_view", "list_clip", "list_box")
                                    if list_box and mission_button then
                                        for i = 0, list_box:ChildCount() - 1 do
                                            local quest_uic = UIComponent(list_box:Find(i))
                                            local quest_title = find_uicomponent(quest_uic, "name")
                                            --sm0_log("mission_title = "..mission_title) 
                                            if quest_title and mission_title == quest_title:GetStateText() then
                                                --sm0_log("UI mission_title = "..quest_title:GetStateText())
                                                mission_found = true 
                                            end  
                                        end
                                        if not mission_found then
                                            --sm0_log("force_add_ancillary: "..current_ancillary_key) 
                                            CampaignUI.TriggerCampaignScriptEvent(cm:get_local_faction(true):command_queue_index(), "anc|"..tostring(character:command_queue_index())..":"..current_ancillary_key)
                                        end
                                    end
                                end
                            else
                                --sm0_log("force_add_ancillary: "..current_ancillary_key)
                                cm:disable_event_feed_events(true, "", "", "character_ancillary_gained")
                                cm:force_add_ancillary(character, current_ancillary_key, true, false)
                                cm:disable_event_feed_events(false, "", "", "character_ancillary_gained")
                            end
                        end,
                        false
                    )
                else
                    --sm0_log("ancillary_exists: "..current_ancillary_key)
                end
            end 
        end,
        true
    )
    --Multiplayer listener
    core:add_listener(
        "sm0_backup_UITrigger",
        "UITrigger",
        function(context)
            return context:trigger():starts_with("anc|")
        end,
        function(context)
            local str = context:trigger() --:string
            local info = string.gsub(str, "anc|", "")
            local cqi_end = string.find(info, ":")
            local cqi = string.sub(info, 1, cqi_end - 1) 
            local anc = string.sub(info, cqi_end + 1)
            --# assume cqi: CA_CQI
            local character = cm:get_character_by_cqi(cqi)
            cm:disable_event_feed_events(true, "", "", "character_ancillary_gained")
            cm:force_add_ancillary(character, anc, true, false) 
            cm:disable_event_feed_events(false, "", "", "character_ancillary_gained")
        end,
        true
    )

    -- Fix for missing Turn 1 ancillary
    --
    -- this method won't add the item before the factions turn (important for ai)
    --core:add_listener(
    --	"sm0_missing_anc_CharacterTurnStart",
    --	"CharacterTurnStart",
    --	function(context)
    --		return context:character():character_subtype("wh2_dlc13_lzd_gor_rok") and context:character():rank() >= 1 
    --		and not cm:model():world():ancillary_exists("wh2_dlc13_anc_weapon_mace_of_ulumak")
    --	end,
    --	function(context)
    --		cm:force_add_ancillary(context:character(), "wh2_dlc13_anc_weapon_mace_of_ulumak", true, true)
    --	end,
    --	false
    --)

    -- this method is better because it behaves the same way starting items are added to Tehenhauin and Tiktaq'to
    core:add_listener(
        "sm0_missing_anc_FactionTurnStart",
        "FactionTurnStart",
        true,
        function(context)
            for _, anc in pairs(missing_anc) do
                if not cm:model():world():ancillary_exists(anc.key) then
                    local faction = cm:get_faction(anc.faction)
                    local not_found = true
                    if faction then
                        local character_list = faction:character_list()
                        for i = 0, character_list:num_items() - 1 do
                            local character = character_list:item_at(i)
                            if character:character_subtype(anc.subtype) and character:rank() >= 1 then
                                cm:force_add_ancillary(character, anc.key, true, true)
                                not_found = false
                                break
                            end
                        end
                        if not_found then
                            local faction_list = faction:factions_of_same_subculture()
                            for i = 0, faction_list:num_items() - 1 do
                                local subc_faction = faction_list:item_at(i)
                                local character_list = subc_faction:character_list()
                                for j = 0, character_list:num_items() - 1 do
                                    local character = character_list:item_at(j)
                                    if character:character_subtype(anc.subtype) and character:rank() >= 1 then
                                        cm:force_add_ancillary(character, anc.key, true, true)
                                        break
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end,
        true
    )
end